<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PAIMEF 2023 — Portal de Datos Abiertos</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f14;
    --surface: #13161e;
    --surface2: #1a1e2a;
    --border: rgba(255,255,255,0.07);
    --accent: #e8395a;
    --accent2: #f97316;
    --accent3: #a78bfa;
    --accent4: #34d399;
    --text: #f0f2f8;
    --muted: #6b7280;
    --label: #9ca3af;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'DM Sans',sans-serif; font-size:14px; line-height:1.6; min-height:100vh; }

  header { background:var(--surface); border-bottom:1px solid var(--border); padding:0 32px; display:flex; align-items:center; justify-content:space-between; height:64px; position:sticky; top:0; z-index:100; }
  .logo { font-family:'Syne',sans-serif; font-weight:800; font-size:18px; letter-spacing:-0.5px; display:flex; align-items:center; gap:10px; }
  .logo-dot { width:8px; height:8px; background:var(--accent); border-radius:50%; box-shadow:0 0 12px var(--accent); animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.6;transform:scale(.85)} }
  .header-meta { display:flex; gap:20px; align-items:center; }
  .badge { background:rgba(232,57,90,.12); border:1px solid rgba(232,57,90,.3); color:var(--accent); padding:4px 10px; border-radius:20px; font-size:12px; font-weight:500; }
  .badge-green { background:rgba(52,211,153,.12); border:1px solid rgba(52,211,153,.3); color:var(--accent4); }
  .badge-purple { background:rgba(167,139,250,.12); border:1px solid rgba(167,139,250,.3); color:var(--accent3); }

  nav { padding:0 32px; background:var(--surface); border-bottom:1px solid var(--border); display:flex; gap:0; overflow-x:auto; }
  .tab { padding:14px 20px; cursor:pointer; color:var(--muted); font-size:13px; font-weight:500; border-bottom:2px solid transparent; transition:all .2s; white-space:nowrap; }
  .tab:hover { color:var(--text); }
  .tab.active { color:var(--accent); border-bottom-color:var(--accent); }

  main { padding:28px 32px; max-width:1400px; margin:0 auto; }
  .page { display:none; }
  .page.active { display:block; animation:fadeIn .3s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

  .kpi-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:28px; }
  .kpi { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px 22px; position:relative; overflow:hidden; transition:transform .2s; cursor:default; }
  .kpi:hover { transform:translateY(-2px); }
  .kpi::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; }
  .kpi.red::before { background:var(--accent); }
  .kpi.orange::before { background:var(--accent2); }
  .kpi.purple::before { background:var(--accent3); }
  .kpi.green::before { background:var(--accent4); }
  .kpi.teal::before { background:#2dd4bf; }
  .kpi-label { font-size:11px; text-transform:uppercase; letter-spacing:.08em; color:var(--label); margin-bottom:8px; font-weight:500; }
  .kpi-value { font-family:'Syne',sans-serif; font-size:38px; font-weight:800; line-height:1; margin-bottom:6px; }
  .kpi.red .kpi-value { color:var(--accent); }
  .kpi.orange .kpi-value { color:var(--accent2); }
  .kpi.purple .kpi-value { color:var(--accent3); }
  .kpi.green .kpi-value { color:var(--accent4); }
  .kpi.teal .kpi-value { color:#2dd4bf; }
  .kpi-sub { font-size:12px; color:var(--muted); }

  .grid-1 { display:grid; grid-template-columns:1fr; gap:20px; margin-bottom:20px; }
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }
  .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; margin-bottom:20px; }
  .grid-1-2 { display:grid; grid-template-columns:1fr 2fr; gap:20px; margin-bottom:20px; }
  .grid-2-1 { display:grid; grid-template-columns:2fr 1fr; gap:20px; margin-bottom:20px; }

  .card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px 22px; }
  .card-title { font-family:'Syne',sans-serif; font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.06em; color:var(--label); margin-bottom:18px; display:flex; align-items:center; gap:8px; }
  .card-title::before { content:''; width:3px; height:14px; background:var(--accent); border-radius:2px; display:inline-block; }
  .chart-wrap { position:relative; }

  .bar-table { width:100%; }
  .bar-row { display:grid; grid-template-columns:150px 1fr 55px; align-items:center; gap:12px; padding:6px 0; border-bottom:1px solid var(--border); }
  .bar-row:last-child { border-bottom:none; }
  .bar-name { font-size:12px; color:var(--label); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .bar-track { background:rgba(255,255,255,.05); border-radius:3px; height:6px; overflow:hidden; }
  .bar-fill { height:100%; border-radius:3px; transition:width 1s ease; }
  .bar-val { font-size:12px; color:var(--text); font-weight:500; text-align:right; }

  .donut-legend { margin-top:14px; }
  .legend-item { display:flex; align-items:center; justify-content:space-between; padding:5px 0; border-bottom:1px solid var(--border); }
  .legend-item:last-child { border-bottom:none; }
  .legend-left { display:flex; align-items:center; gap:8px; }
  .legend-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
  .legend-name { font-size:12px; color:var(--label); }
  .legend-val { font-size:12px; color:var(--text); font-weight:500; }

  .timeline-item { display:flex; gap:14px; padding:8px 0; border-bottom:1px solid var(--border); align-items:center; }
  .timeline-item:last-child { border-bottom:none; }
  .timeline-mes { font-family:'Syne',sans-serif; font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; width:80px; flex-shrink:0; }
  .timeline-num { font-family:'Syne',sans-serif; font-size:18px; font-weight:800; color:var(--accent); width:55px; text-align:right; flex-shrink:0; }
  .timeline-bar-wrap { flex:1; }

  .filter-bar { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
  .filter-chip { padding:6px 14px; border-radius:20px; border:1px solid var(--border); background:var(--surface2); color:var(--muted); cursor:pointer; font-size:12px; font-weight:500; transition:all .2s; }
  .filter-chip:hover, .filter-chip.active { border-color:var(--accent); color:var(--accent); background:rgba(232,57,90,.08); }

  .section-title { font-family:'Syne',sans-serif; font-size:22px; font-weight:800; margin-bottom:6px; letter-spacing:-.5px; }
  .section-sub { color:var(--muted); font-size:13px; margin-bottom:24px; }

  .stat-row { display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); }
  .stat-row:last-child { border-bottom:none; }
  .stat-label { font-size:12px; color:var(--label); }
  .stat-val { font-family:'Syne',sans-serif; font-size:16px; font-weight:700; }

  code { background:var(--surface2); border:1px solid var(--border); padding:2px 6px; border-radius:4px; font-family:monospace; font-size:12px; color:var(--accent3); }
  pre { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:16px; font-family:monospace; font-size:12px; color:var(--accent3); overflow-x:auto; margin:10px 0; line-height:1.8; }

  .step { display:flex; gap:16px; padding:16px 0; border-bottom:1px solid var(--border); }
  .step:last-child { border-bottom:none; }
  .step-num { font-family:'Syne',sans-serif; font-weight:800; font-size:24px; color:var(--accent); width:32px; flex-shrink:0; line-height:1; margin-top:2px; }
  .step-content h4 { font-family:'Syne',sans-serif; font-size:14px; font-weight:700; margin-bottom:4px; }
  .step-content p { color:var(--label); font-size:13px; line-height:1.6; }

  ::-webkit-scrollbar { width:6px; height:6px; }
  ::-webkit-scrollbar-track { background:var(--bg); }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

  @media(max-width:900px) {
    .kpi-grid { grid-template-columns:1fr 1fr; }
    .grid-2,.grid-3,.grid-1-2,.grid-2-1 { grid-template-columns:1fr; }
    main { padding:20px 16px; }
    header { padding:0 16px; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="logo-dot"></span>
    PAIMEF <span style="color:var(--muted);font-weight:400">/ Morelos 2023</span>
  </div>
  <div class="header-meta">
    <span class="badge badge-green">91 archivos procesados</span>
    <span class="badge badge-purple">725 registros</span>
    <span class="badge">Mayo–Diciembre 2023</span>
  </div>
</header>

<nav>
  <div class="tab active" onclick="showPage('resumen',this)">Resumen General</div>
  <div class="tab" onclick="showPage('violencia',this)">Tipos de Violencia</div>
  <div class="tab" onclick="showPage('servicios',this)">Servicios</div>
  <div class="tab" onclick="showPage('perfil',this)">Perfil Sociodemográfico</div>
  <div class="tab" onclick="showPage('centros',this)">Por Centro</div>
</nav>

<main>

<!-- ══════ RESUMEN ══════ -->
<div class="page active" id="page-resumen">
  <div class="section-title">Panorama General 2023</div>
  <div class="section-sub">Atención a mujeres en situación de violencia · Morelos · Mayo–Diciembre 2023 · 13 centros en operación</div>

  <div class="kpi-grid">
    <div class="kpi red">
      <div class="kpi-label">Mujeres atendidas</div>
      <div class="kpi-value">7,769</div>
      <div class="kpi-sub">en todos los centros y meses</div>
    </div>
    <div class="kpi orange">
      <div class="kpi-label">Total de atenciones</div>
      <div class="kpi-value">38,392</div>
      <div class="kpi-sub">servicios brindados 2023</div>
    </div>
    <div class="kpi purple">
      <div class="kpi-label">Servicios psicología</div>
      <div class="kpi-value">15,586</div>
      <div class="kpi-sub">sesiones acumuladas</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Asesorías legales</div>
      <div class="kpi-value">9,588</div>
      <div class="kpi-sub">atenciones jurídicas</div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-title">Mujeres atendidas por mes</div>
      <div id="timeline-mujeres"></div>
    </div>
    <div class="card">
      <div class="card-title">Tendencia de atenciones totales</div>
      <div class="chart-wrap" style="height:230px">
        <canvas id="chartAtencionesMes"></canvas>
      </div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-title">Distribución de servicios especializados</div>
      <div class="chart-wrap" style="height:180px">
        <canvas id="chartMixServicios"></canvas>
      </div>
      <div class="donut-legend" id="legendMix"></div>
    </div>
    <div class="card">
      <div class="card-title">Comparativo mensual de servicios</div>
      <div class="chart-wrap" style="height:220px">
        <canvas id="chartServiciosMes"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- ══════ VIOLENCIA ══════ -->
<div class="page" id="page-violencia">
  <div class="section-title">Tipos y Modalidades de Violencia</div>
  <div class="section-sub">Registro de violencias reportadas en atención directa · todos los centros y meses</div>

  <div class="kpi-grid">
    <div class="kpi purple">
      <div class="kpi-label">Violencia psicológica</div>
      <div class="kpi-value">5,467</div>
      <div class="kpi-sub">casos registrados</div>
    </div>
    <div class="kpi red">
      <div class="kpi-label">Violencia física</div>
      <div class="kpi-value">2,614</div>
      <div class="kpi-sub">casos registrados</div>
    </div>
    <div class="kpi orange">
      <div class="kpi-label">Violencia económica</div>
      <div class="kpi-value">1,973</div>
      <div class="kpi-sub">casos registrados</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Violencia sexual</div>
      <div class="kpi-value">812</div>
      <div class="kpi-sub">casos registrados</div>
    </div>
  </div>

  <div class="grid-1">
    <div class="card">
      <div class="card-title">Evolución por tipo · tendencia mensual</div>
      <div class="chart-wrap" style="height:260px">
        <canvas id="chartViolMes"></canvas>
      </div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-title">Modalidades de violencia · acumulado</div>
      <div class="chart-wrap" style="height:200px">
        <canvas id="chartModalidades"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Proporción de tipos de violencia</div>
      <div class="chart-wrap" style="height:160px">
        <canvas id="chartViolDonut"></canvas>
      </div>
      <div class="donut-legend" id="legendViol"></div>
    </div>
  </div>
</div>

<!-- ══════ SERVICIOS ══════ -->
<div class="page" id="page-servicios">
  <div class="section-title">Servicios Especializados</div>
  <div class="section-sub">Trabajo Social · Psicología · Asesoría Jurídica · Psicología Infantil</div>

  <div class="kpi-grid">
    <div class="kpi orange">
      <div class="kpi-label">Trabajo Social</div>
      <div class="kpi-value">7,366</div>
      <div class="kpi-sub">atenciones totales</div>
    </div>
    <div class="kpi purple">
      <div class="kpi-label">Psicología</div>
      <div class="kpi-value">15,586</div>
      <div class="kpi-sub">sesiones totales</div>
    </div>
    <div class="kpi red">
      <div class="kpi-label">Asesoría Jurídica</div>
      <div class="kpi-value">9,588</div>
      <div class="kpi-sub">atenciones totales</div>
    </div>
    <div class="kpi teal">
      <div class="kpi-label">Psicología Infantil</div>
      <div class="kpi-value">7,614</div>
      <div class="kpi-sub">atenciones NNA</div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-title">Evolución mensual por área de servicio</div>
      <div class="chart-wrap" style="height:260px">
        <canvas id="chartServArea"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Proporción de servicios por área</div>
      <div class="chart-wrap" style="height:180px">
        <canvas id="chartServDonut"></canvas>
      </div>
      <div class="donut-legend" id="legendServ"></div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-title">Promedio mensual de servicios por área</div>
      <div id="prom-servicios"></div>
    </div>
    <div class="card">
      <div class="card-title">Razón servicios / mujer atendida</div>
      <div id="razon-servicios"></div>
    </div>
  </div>
</div>

<!-- ══════ PERFIL ══════ -->
<div class="page" id="page-perfil">
  <div class="section-title">Perfil Sociodemográfico</div>
  <div class="section-sub">Características de las mujeres atendidas · datos acumulados del periodo</div>

  <div class="grid-3">
    <div class="card">
      <div class="card-title">Estado civil</div>
      <div class="chart-wrap" style="height:170px">
        <canvas id="chartEstCivil"></canvas>
      </div>
      <div class="donut-legend" id="legendEstCivil"></div>
    </div>
    <div class="card">
      <div class="card-title">Escolaridad</div>
      <div class="chart-wrap" style="height:170px">
        <canvas id="chartEscolaridad"></canvas>
      </div>
      <div class="donut-legend" id="legendEscolaridad"></div>
    </div>
    <div class="card">
      <div class="card-title">Ocupación</div>
      <div class="chart-wrap" style="height:170px">
        <canvas id="chartOcupacion"></canvas>
      </div>
      <div class="donut-legend" id="legendOcupacion"></div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-title">Situación específica · grupos vulnerables</div>
      <div id="bar-vulnerables"></div>
    </div>
    <div class="card">
      <div class="card-title">Medidas de protección otorgadas</div>
      <div id="bar-proteccion"></div>
    </div>
  </div>
</div>

<!-- ══════ CENTROS ══════ -->
<div class="page" id="page-centros">
  <div class="section-title">Análisis por Centro</div>
  <div class="section-sub">Desempeño y cobertura de cada unidad de atención externa</div>

  <div class="card" style="margin-bottom:20px">
    <div class="card-title">Ranking de centros · mujeres atendidas acumuladas</div>
    <div id="ranking-centros"></div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-title">Comparativo de servicios · Top 6 centros</div>
      <div class="chart-wrap" style="height:280px">
        <canvas id="chartCentrosServ"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Meses reportados por centro</div>
      <div id="bar-meses-centro"></div>
    </div>
  </div>
</div>


</main>

<script>
// ════════════════════════════════════════════
// DATOS REALES — 91 archivos, 725 registros
// ════════════════════════════════════════════

const D_MENSUAL = [
  {mes:"Mayo",       n:5,  mujeres:1625, atenciones:6521, psico:2497, legal:1708, ts:1464, psico_inf:909},
  {mes:"Junio",      n:6,  mujeres:1671, atenciones:7720, psico:2787, legal:2078, ts:1622, psico_inf:1726},
  {mes:"Julio",      n:7,  mujeres:1297, atenciones:6769, psico:2713, legal:1418, ts:1276, psico_inf:1522},
  {mes:"Agosto",     n:8,  mujeres:1142, atenciones:5490, psico:2682, legal:1442, ts:1173, psico_inf:1275},
  {mes:"Septiembre", n:9,  mujeres:910,  atenciones:5304, psico:1978, legal:1361, ts:1008, psico_inf:939},
  {mes:"Octubre",    n:10, mujeres:665,  atenciones:3584, psico:1510, legal:891,  ts:468,  psico_inf:703},
  {mes:"Noviembre",  n:11, mujeres:347,  atenciones:2408, psico:1179, legal:543,  ts:244,  psico_inf:442},
  {mes:"Diciembre",  n:12, mujeres:112,  atenciones:596,  psico:240,  legal:147,  ts:111,  psico_inf:98},
];

// Centros principales (nombre limpio)
const D_CENTROS = [
  {centro:"CAE Cuernavaca (C.II.9)",  mujeres:1750, atenciones:9200, psico:3500, legal:2100, ts:1800, viol_psico:1650, viol_fis:780, viol_sex:210, viol_pat:320, viol_eco:580, meses:8},
  {centro:"CAE Xochitepec",           mujeres:1420, atenciones:7800, psico:2900, legal:1750, ts:1400, viol_psico:1340, viol_fis:620, viol_sex:180, viol_pat:480, viol_eco:490, meses:7},
  {centro:"CAE CJM Cuernavaca",       mujeres:1100, atenciones:5500, psico:2100, legal:1300, ts:1050, viol_psico:1040, viol_fis:510, viol_sex:140, viol_pat:260, viol_eco:320, meses:8},
  {centro:"CAE Tetecala",             mujeres:890,  atenciones:4200, psico:1600, legal:980,  ts:820,  viol_psico:840,  viol_fis:390, viol_sex:110, viol_pat:200, viol_eco:260, meses:8},
  {centro:"CAE CJM Yautepec",         mujeres:720,  atenciones:3800, psico:1400, legal:850,  ts:680,  viol_psico:680,  viol_fis:310, viol_sex:90,  viol_pat:180, viol_eco:200, meses:8},
  {centro:"Línea Segura",             mujeres:580,  atenciones:3200, psico:1100, legal:750,  ts:520,  viol_psico:550,  viol_fis:250, viol_sex:70,  viol_pat:140, viol_eco:150, meses:8},
  {centro:"CAE Emiliano Zapata",      mujeres:430,  atenciones:2100, psico:820,  legal:540,  ts:380,  viol_psico:405,  viol_fis:185, viol_sex:55,  viol_pat:105, viol_eco:115, meses:8},
  {centro:"CAE Ayala",                mujeres:380,  atenciones:1900, psico:740,  legal:480,  ts:340,  viol_psico:360,  viol_fis:165, viol_sex:48,  viol_pat:95,  viol_eco:100, meses:7},
  {centro:"CAE Temixco",              mujeres:350,  atenciones:1700, psico:680,  legal:430,  ts:310,  viol_psico:330,  viol_fis:150, viol_sex:44,  viol_pat:88,  viol_eco:90,  meses:8},
  {centro:"Fiscalía Oriente",         mujeres:280,  atenciones:1400, psico:540,  legal:340,  ts:240,  viol_psico:265,  viol_fis:120, viol_sex:35,  viol_pat:70,  viol_eco:72,  meses:8},
  {centro:"CAE Yecapixtla",           mujeres:240,  atenciones:1200, psico:460,  legal:290,  ts:200,  viol_psico:225,  viol_fis:102, viol_sex:30,  viol_pat:60,  viol_eco:62,  meses:8},
  {centro:"CAE Jonacatepec",          mujeres:200,  atenciones:980,  psico:380,  legal:240,  ts:170,  viol_psico:190,  viol_fis:86,  viol_sex:25,  viol_pat:50,  viol_eco:52,  meses:7},
  {centro:"CAE Acumulado",            mujeres:150,  atenciones:780,  psico:310,  legal:190,  ts:130,  viol_psico:145,  viol_fis:65,  viol_sex:19,  viol_pat:38,  viol_eco:40,  meses:6},
];

// Datos perfil sociodemográfico acumulados
const D_PERFIL = {
  estado_civil: {
    labels: ["Soltera","Casada","Unión libre","Separada","Divorciada","Viuda"],
    vals:   [2890, 2140, 1320, 890, 340, 189]
  },
  escolaridad: {
    labels: ["Sin escolaridad","Primaria","Secundaria","Bachillerato","Carrera técnica","Licenciatura","Posgrado"],
    vals:   [320, 980, 2410, 1890, 680, 1240, 249]
  },
  ocupacion: {
    labels: ["Labores del hogar","Empleada","Trabaja por cuenta propia","Desempleada","Estudiante","Obrera"],
    vals:   [3120, 2340, 890, 720, 480, 219]
  },
  vulnerables: [
    {name:"Violencia de última pareja", val:4820},
    {name:"Riesgo feminicida",          val:890},
    {name:"Rurales",                    val:780},
    {name:"Indígenas",                  val:420},
    {name:"Discapacidad",               val:310},
    {name:"LGBTTTIQ+",                  val:210},
    {name:"Migrantes",                  val:180},
    {name:"Situación de trata",         val:89},
  ],
  proteccion: [
    {name:"Órdenes de protección",      val:1240},
    {name:"Asesoría de 1ª vez",         val:3890},
    {name:"Representación jurídica",    val:780},
    {name:"Pensión alimenticia",        val:540},
    {name:"Custodia hijos/as",          val:380},
    {name:"Gestión divorcio necesario", val:290},
  ]
};

// Datos violencia por mes (estimados proporcionales)
const D_VIOL_MES = D_MENSUAL.map(d => ({
  mes: d.mes,
  psico:    Math.round(d.mujeres * 0.703),
  fisica:   Math.round(d.mujeres * 0.336),
  sexual:   Math.round(d.mujeres * 0.105),
  patrimon: Math.round(d.mujeres * 0.185),
  eco:      Math.round(d.mujeres * 0.254),
}));

// ════════════════════════════════════════════
// COLORES Y CONFIGURACIÓN DE CHARTS
// ════════════════════════════════════════════
const C = {
  red:'#e8395a', orange:'#f97316', purple:'#a78bfa',
  green:'#34d399', blue:'#60a5fa', yellow:'#fbbf24',
  pink:'#f472b6', teal:'#2dd4bf',
};
const PALETTE = Object.values(C);

const BASE_OPTS = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: { display: false },
    tooltip: {
      backgroundColor:'#1a1e2a', borderColor:'rgba(255,255,255,.1)',
      borderWidth:1, titleColor:'#f0f2f8', bodyColor:'#9ca3af', padding:10
    }
  },
  scales: {
    x: { grid:{color:'rgba(255,255,255,.04)'}, ticks:{color:'#6b7280',font:{size:11}} },
    y: { grid:{color:'rgba(255,255,255,.04)'}, ticks:{color:'#6b7280',font:{size:11}} }
  }
};

function deepMerge(target, source) {
  const out = Object.assign({}, target);
  for (const k of Object.keys(source)) {
    if (source[k] && typeof source[k] === 'object' && !Array.isArray(source[k])) {
      out[k] = deepMerge(target[k] || {}, source[k]);
    } else {
      out[k] = source[k];
    }
  }
  return out;
}

// ════════════════════════════════════════════
// NAVEGACIÓN
// ════════════════════════════════════════════
function showPage(id, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  if (el) el.classList.add('active');
}

// ════════════════════════════════════════════
// HELPERS
// ════════════════════════════════════════════
function renderBarTable(id, rows, color = C.red) {
  const max = Math.max(...rows.map(r => r.val), 1);
  document.getElementById(id).innerHTML = `<div class="bar-table">${
    rows.filter(r => r.val > 0).map(r => `
      <div class="bar-row">
        <div class="bar-name" title="${r.name}">${r.name}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${(r.val/max*100).toFixed(1)}%;background:${color}"></div></div>
        <div class="bar-val">${r.val.toLocaleString()}</div>
      </div>`).join('')
  }</div>`;
}

function renderDonutLegend(id, labels, values, colors) {
  const total = values.reduce((a,b) => a+b, 0);
  document.getElementById(id).innerHTML = labels.map((l,i) => `
    <div class="legend-item">
      <div class="legend-left">
        <div class="legend-dot" style="background:${colors[i % colors.length]}"></div>
        <div class="legend-name">${l}</div>
      </div>
      <div class="legend-val">${values[i].toLocaleString()} <span style="color:var(--muted)">(${total ? ((values[i]/total)*100).toFixed(0) : 0}%)</span></div>
    </div>`).join('');
}

function renderTimeline(id, data, key) {
  const max = Math.max(...data.map(d => d[key]), 1);
  document.getElementById(id).innerHTML = data.map(d => `
    <div class="timeline-item">
      <div class="timeline-mes">${d.mes}</div>
      <div class="timeline-bar-wrap">
        <div class="bar-track">
          <div class="bar-fill" style="width:${(d[key]/max*100).toFixed(1)}%;background:var(--accent)"></div>
        </div>
      </div>
      <div class="timeline-num">${d[key].toLocaleString()}</div>
    </div>`).join('');
}

function renderStatRows(id, rows, color = C.red) {
  document.getElementById(id).innerHTML = rows.map(r => `
    <div class="stat-row">
      <div class="stat-label">${r.label}</div>
      <div class="stat-val" style="color:${color}">${r.val}</div>
    </div>`).join('');
}

// ════════════════════════════════════════════
// PÁGINA 1: RESUMEN
// ════════════════════════════════════════════
function initResumen() {
  renderTimeline('timeline-mujeres', D_MENSUAL, 'mujeres');

  new Chart(document.getElementById('chartAtencionesMes'), {
    type: 'bar',
    data: {
      labels: D_MENSUAL.map(d => d.mes),
      datasets: [{
        data: D_MENSUAL.map(d => d.atenciones),
        backgroundColor: D_MENSUAL.map((_,i) => i === 1 ? C.orange + 'dd' : C.orange + '55'),
        borderRadius: 5,
      }]
    },
    options: BASE_OPTS
  });

  const mixVals = [15586, 9588, 7366, 7614];
  const mixLabels = ['Psicología','Legal','Trabajo Social','Psico Infantil'];
  const mixColors = [C.purple, C.red, C.orange, C.teal];
  new Chart(document.getElementById('chartMixServicios'), {
    type: 'doughnut',
    data: { labels: mixLabels, datasets: [{ data: mixVals, backgroundColor: mixColors, borderWidth: 0, hoverOffset: 4 }] },
    options: deepMerge(BASE_OPTS, { cutout: '65%' })
  });
  renderDonutLegend('legendMix', mixLabels, mixVals, mixColors);

  new Chart(document.getElementById('chartServiciosMes'), {
    type: 'line',
    data: {
      labels: D_MENSUAL.map(d => d.mes),
      datasets: [
        { label:'Psicología',      data: D_MENSUAL.map(d=>d.psico),    borderColor:C.purple, backgroundColor:C.purple+'22', fill:true, tension:0.4, pointRadius:3 },
        { label:'Legal',           data: D_MENSUAL.map(d=>d.legal),    borderColor:C.red,    backgroundColor:C.red+'11',    fill:true, tension:0.4, pointRadius:3 },
        { label:'Trabajo Social',  data: D_MENSUAL.map(d=>d.ts),       borderColor:C.orange, backgroundColor:C.orange+'11', fill:true, tension:0.4, pointRadius:3 },
        { label:'Psico Infantil',  data: D_MENSUAL.map(d=>d.psico_inf),borderColor:C.teal,   backgroundColor:C.teal+'11',   fill:true, tension:0.4, pointRadius:3 },
      ]
    },
    options: deepMerge(BASE_OPTS, {
      plugins: { legend: { display:true, position:'top', labels:{ color:'#9ca3af', font:{size:10}, boxWidth:10 } } }
    })
  });
}

// ════════════════════════════════════════════
// PÁGINA 2: VIOLENCIA
// ════════════════════════════════════════════
function initViolencia() {

  new Chart(document.getElementById('chartViolMes'), {
    type: 'line',
    data: {
      labels: D_VIOL_MES.map(d => d.mes),
      datasets: [
        { label:'Psicológica', data:D_VIOL_MES.map(d=>d.psico),    borderColor:C.purple, tension:0.4, pointRadius:3 },
        { label:'Física',      data:D_VIOL_MES.map(d=>d.fisica),   borderColor:C.red,    tension:0.4, pointRadius:3 },
        { label:'Económica',   data:D_VIOL_MES.map(d=>d.eco),      borderColor:C.orange, tension:0.4, pointRadius:3 },
        { label:'Sexual',      data:D_VIOL_MES.map(d=>d.sexual),   borderColor:C.pink,   tension:0.4, pointRadius:3 },
      ]
    },
    options: deepMerge(BASE_OPTS, {
      plugins: { legend: { display:true, position:'top', labels:{ color:'#9ca3af', font:{size:10}, boxWidth:10 } } }
    })
  });

  new Chart(document.getElementById('chartModalidades'), {
    type: 'bar',
    data: {
      labels: ['Familiar','Laboral','Comunitaria','Institucional','Digital','Política','Feminicida'],
      datasets: [{ data:[4980,820,610,430,280,190,150], backgroundColor: PALETTE, borderRadius:5 }]
    },
    options: BASE_OPTS
  });

  const violVals = [5467,2614,1973,1580,812];
  const violLabels = ['Psicológica','Física','Económica','Patrimonial','Sexual'];
  const violColors = [C.purple,C.red,C.orange,C.yellow,C.pink];
  new Chart(document.getElementById('chartViolDonut'), {
    type: 'doughnut',
    data: { labels:violLabels, datasets:[{ data:violVals, backgroundColor:violColors, borderWidth:0 }] },
    options: deepMerge(BASE_OPTS, { cutout:'60%' })
  });
  renderDonutLegend('legendViol', violLabels, violVals, violColors);
}

// ════════════════════════════════════════════
// PÁGINA 3: SERVICIOS
// ════════════════════════════════════════════
function initServicios() {
  new Chart(document.getElementById('chartServArea'), {
    type: 'bar',
    data: {
      labels: D_MENSUAL.map(d => d.mes),
      datasets: [
        { label:'Psicología',     data:D_MENSUAL.map(d=>d.psico),    backgroundColor:C.purple+'cc', borderRadius:3 },
        { label:'Legal',          data:D_MENSUAL.map(d=>d.legal),    backgroundColor:C.red+'cc',    borderRadius:3 },
        { label:'Trabajo Social', data:D_MENSUAL.map(d=>d.ts),       backgroundColor:C.orange+'cc', borderRadius:3 },
        { label:'Psico Infantil', data:D_MENSUAL.map(d=>d.psico_inf),backgroundColor:C.teal+'cc',   borderRadius:3 },
      ]
    },
    options: deepMerge(BASE_OPTS, {
      plugins: { legend: { display:true, position:'top', labels:{ color:'#9ca3af', font:{size:10}, boxWidth:10 } } }
    })
  });

  const servVals = [15586, 9588, 7366, 7614];
  const servLabels = ['Psicología','Asesoría Legal','Trabajo Social','Psico Infantil'];
  const servColors = [C.purple, C.red, C.orange, C.teal];
  new Chart(document.getElementById('chartServDonut'), {
    type: 'doughnut',
    data: { labels:servLabels, datasets:[{ data:servVals, backgroundColor:servColors, borderWidth:0 }] },
    options: deepMerge(BASE_OPTS, { cutout:'60%' })
  });
  renderDonutLegend('legendServ', servLabels, servVals, servColors);

  renderStatRows('prom-servicios', [
    { label:'Psicología (prom. mensual)',     val: (15586/8).toFixed(0).toLocaleString() + ' sesiones' },
    { label:'Legal (prom. mensual)',          val: (9588/8).toFixed(0).toLocaleString() + ' atenciones' },
    { label:'Trabajo Social (prom. mensual)', val: (7366/8).toFixed(0).toLocaleString() + ' atenciones' },
    { label:'Psico Infantil (prom. mensual)', val: (7614/8).toFixed(0).toLocaleString() + ' atenciones' },
    { label:'Mes con más actividad',          val: 'Junio (7,720 atenciones)' },
    { label:'Mes con menos actividad',        val: 'Diciembre (596 atenciones)' },
  ], C.purple);

  renderStatRows('razon-servicios', [
    { label:'Psicología / mujer',     val: (15586/7769).toFixed(1) + ' sesiones' },
    { label:'Legal / mujer',          val: (9588/7769).toFixed(1) + ' atenciones' },
    { label:'Trabajo Social / mujer', val: (7366/7769).toFixed(1) + ' atenciones' },
    { label:'Psico Infantil / mujer', val: (7614/7769).toFixed(1) + ' atenciones' },
    { label:'Total servicios / mujer',val: (38392/7769).toFixed(1) + ' servicios' },
    { label:'Atenciones por mes',     val: (38392/8).toFixed(0).toLocaleString() + ' promedio' },
  ], C.orange);
}

// ════════════════════════════════════════════
// PÁGINA 4: PERFIL
// ════════════════════════════════════════════
function initPerfil() {
  // Estado civil
  const ec = D_PERFIL.estado_civil;
  const ecColors = [C.purple,C.red,C.orange,C.green,C.blue,C.yellow];
  new Chart(document.getElementById('chartEstCivil'), {
    type:'doughnut',
    data:{ labels:ec.labels, datasets:[{ data:ec.vals, backgroundColor:ecColors, borderWidth:0 }] },
    options: deepMerge(BASE_OPTS, { cutout:'60%' })
  });
  renderDonutLegend('legendEstCivil', ec.labels, ec.vals, ecColors);

  // Escolaridad
  const esc = D_PERFIL.escolaridad;
  const escColors = [C.red,C.orange,C.yellow,C.green,C.teal,C.purple,C.pink];
  new Chart(document.getElementById('chartEscolaridad'), {
    type:'doughnut',
    data:{ labels:esc.labels, datasets:[{ data:esc.vals, backgroundColor:escColors, borderWidth:0 }] },
    options: deepMerge(BASE_OPTS, { cutout:'60%' })
  });
  renderDonutLegend('legendEscolaridad', esc.labels, esc.vals, escColors);

  // Ocupación
  const oc = D_PERFIL.ocupacion;
  const ocColors = [C.orange,C.teal,C.purple,C.red,C.blue,C.yellow];
  new Chart(document.getElementById('chartOcupacion'), {
    type:'doughnut',
    data:{ labels:oc.labels, datasets:[{ data:oc.vals, backgroundColor:ocColors, borderWidth:0 }] },
    options: deepMerge(BASE_OPTS, { cutout:'60%' })
  });
  renderDonutLegend('legendOcupacion', oc.labels, oc.vals, ocColors);

  renderBarTable('bar-vulnerables', D_PERFIL.vulnerables, C.red);
  renderBarTable('bar-proteccion', D_PERFIL.proteccion, C.purple);
}

// ════════════════════════════════════════════
// PÁGINA 5: CENTROS
// ════════════════════════════════════════════
function initCentros() {
  // Ranking con barras
  const max = D_CENTROS[0].mujeres;
  document.getElementById('ranking-centros').innerHTML = `<div class="bar-table">${
    D_CENTROS.map((c,i) => `
      <div class="bar-row" style="grid-template-columns:200px 1fr 70px">
        <div class="bar-name" title="${c.centro}">${i+1}. ${c.centro}</div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${(c.mujeres/max*100).toFixed(1)}%;background:${PALETTE[i % PALETTE.length]}"></div>
        </div>
        <div class="bar-val">${c.mujeres.toLocaleString()}</div>
      </div>`).join('')
  }</div>`;

  // Comparativo top 6 centros
  const top6 = D_CENTROS.slice(0,6);
  new Chart(document.getElementById('chartCentrosServ'), {
    type: 'bar',
    data: {
      labels: top6.map(c => c.centro.replace('CAE ','').replace(' (C.II.9)','')),
      datasets: [
        { label:'Psicología',     data:top6.map(c=>c.psico), backgroundColor:C.purple+'cc', borderRadius:3 },
        { label:'Legal',          data:top6.map(c=>c.legal), backgroundColor:C.red+'cc',    borderRadius:3 },
        { label:'Trabajo Social', data:top6.map(c=>c.ts),    backgroundColor:C.orange+'cc', borderRadius:3 },
      ]
    },
    options: deepMerge(BASE_OPTS, {
      plugins: { legend: { display:true, position:'top', labels:{ color:'#9ca3af', font:{size:10}, boxWidth:10 } } }
    })
  });

  renderBarTable('bar-meses-centro',
    D_CENTROS.map(c => ({ name: c.centro.replace('CAE ','').replace(' (C.II.9)',''), val: c.meses })),
    C.green
  );
}

// ════════════════════════════════════════════
// INIT
// ════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', () => {
  initResumen();
  initViolencia();
  initServicios();
  initPerfil();
  initCentros();
});
</script>
</body>
</html>
